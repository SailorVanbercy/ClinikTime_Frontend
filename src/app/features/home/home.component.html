<app-navbar></app-navbar>
<div class="home-container">

  <!-- HERO / SEARCH -->
  <section class="hero-section">
    <div class="hero-content">
      <h1>Prenez soin de votre santÃ©</h1>
      <p>Trouvez un rendez-vous rapide avec un praticien qualifiÃ©.</p>

      <form
        [formGroup]="searchForm"
        (ngSubmit)="onSearch($event)"
        class="search-bar">

        <div class="input-group">
          <i>ğŸ”</i>
          <input
            type="text"
            formControlName="term"
            placeholder="SpÃ©cialitÃ© (ex: Dentiste)">
        </div>

        <div class="divider"></div>

        <button type="submit">Rechercher</button>
      </form>
    </div>
  </section>

  <!-- ğŸ” RESULTATS -->
  <section class="info-section" *ngIf="searched">

    <h2>RÃ©sultats de recherche</h2>

    <p *ngIf="loading">ğŸ”„ Recherche en cours...</p>

    <p *ngIf="!loading && medecins.length === 0">
      Aucun mÃ©decin trouvÃ© pour cette spÃ©cialitÃ©.
    </p>

    <div class="cards-grid" *ngIf="!loading && medecins.length > 0">
      <div class="card" *ngFor="let m of medecins">

        <div class="card-header">
          <div class="avatar-circle">
            {{ getInitial(m.prenom) }}
          </div>

          <div>
            <h3>Dr {{ m.prenom }} {{ m.nom }}</h3>
            <span>ğŸ“ {{ m.telephone }}</span><br>
            <span>ğŸ§‘â€âš•ï¸ {{getSpecialiteName(m.specialiteId)}}</span>
          </div>
        </div>
        <div class="card-body">
          <button
            class="btn-outline"
            (click)="openRdvPanel(m)">
            Prendre rendez-vous
          </button>
        </div>

      </div>
    </div>
  </section>

  <!-- ğŸ©º PANEL PRISE DE RENDEZ-VOUS -->
  <div class="rdv-overlay" *ngIf="showRdvPanel" (click)="closeRdvPanel()">
    <div class="rdv-panel" (click)="$event.stopPropagation()">

      <div class="rdv-header">
        <div>
          <h2>Prendre rendez-vous</h2>
          <p class="rdv-subtitle" *ngIf="selectedMedecin">
            Avec <strong>Dr {{ selectedMedecin.prenom }} {{ selectedMedecin.nom }}</strong>
          </p>
        </div>

        <button class="rdv-close" type="button" (click)="closeRdvPanel()">âœ•</button>
      </div>

      <div class="rdv-form">

        <!-- Fiche patient -->
        <div class="rdv-field">
          <label>Fiche patient</label>
          <select [(ngModel)]="selectedFichePatientId">
            <option [ngValue]="null">-- choisir --</option>
            <option *ngFor="let f of fichesPatients" [ngValue]="f.id ?? null">
              {{ f.prenom }} {{ f.nom }} ({{ f.lienParente }})
            </option>
          </select>
          <p class="rdv-hint" *ngIf="fichesPatients.length === 0">
            Vous n'avez pas encore de fiche patient. CrÃ©ez-en une dans votre profil.
          </p>
        </div>

        <!-- Date -->
        <div class="rdv-field">
          <label>Date</label>
          <input
            type="date"
            [(ngModel)]="selectedDate"
            (ngModelChange)="loadCreneaux()" />
        </div>

        <!-- Motif -->
        <div class="rdv-field">
          <label>Motif (optionnel)</label>
          <input
            type="text"
            [(ngModel)]="motif"
            placeholder="Ex: contrÃ´le, douleur, consultation..." />
        </div>

        <!-- CrÃ©neaux -->
        <div class="rdv-field">
          <div class="rdv-creneaux-head">
            <label>CrÃ©neaux disponibles</label>
            <button
              type="button"
              class="btn-outline rdv-refresh"
              (click)="loadCreneaux()"
              [disabled]="!selectedDate || !selectedMedecin">
              RafraÃ®chir
            </button>
          </div>

          <p *ngIf="loadingCreneaux">ğŸ”„ Chargement des crÃ©neaux...</p>

          <p *ngIf="!loadingCreneaux && selectedDate && creneauxLibres.length === 0">
            Aucun crÃ©neau disponible pour cette date.
          </p>

          <!-- âœ… AFFICHAGE CORRECT DES CRENEAUX -->
          <div class="creneaux-grid" *ngIf="!loadingCreneaux && creneauxLibres.length > 0">
            <button
              type="button"
              class="creneau"
              *ngFor="let c of creneauxLibres"
              [class.selected]="c === selectedCreneau"
              (click)="selectCreneau(c)">
              {{ c.debut | date:'HH:mm' }} â€“ {{ c.fin | date:'HH:mm' }}
            </button>
          </div>
        </div>

        <!-- Actions -->
        <div class="rdv-actions">
          <button type="button" class="btn-cancel" (click)="closeRdvPanel()">
            Annuler
          </button>

          <button
            type="button"
            class="btn-primary"
            (click)="confirmerRdv()"
            [disabled]="!selectedFichePatientId || !selectedCreneau || !selectedMedecin">
            Confirmer le rendez-vous
          </button>
        </div>

      </div>
    </div>
  </div>

  <section class="info-section">
    <h2>Vos derniers rendez-vous</h2>

    <div class="cards-grid">

      <!-- â³ Chargement -->
      <p *ngIf="(myRendezVous$ | async) === null">
        Chargement de vos rendez-vous...
      </p>

      <!-- âŒ Aucun RDV -->
      <p *ngIf="(myRendezVous$ | async)?.length === 0">
        Vous nâ€™avez encore aucun rendez-vous.
      </p>

      <!-- âœ… LISTE RDV -->
      <div
        class="card"
        *ngFor="let rdv of (myRendezVous$ | async)">

        <div class="card-header">
          <div class="avatar-circle">
            {{ getInitial(rdv.medecinPrenom) }}
          </div>

          <div>
            <h3>
              Dr {{ rdv.medecinPrenom }} {{ rdv.medecinNom }}
            </h3>
            <span>ğŸ©º {{ rdv.specialite }}</span>
          </div>
        </div>

        <div class="card-body">
          <p>ğŸ“… {{ rdv.debut | date:'dd/MM/yyyy' }}</p>
          <p>â° {{ rdv.debut | date:'HH:mm' }} â€“ {{ rdv.fin | date:'HH:mm' }}</p>

          <p *ngIf="rdv.motif">
            ğŸ“ {{ rdv.motif }}
          </p>

          <span class="badge"
                [ngClass]="{
                'badge-success': rdv.statut === 'CONFIRME',
                'badge-warning': rdv.statut === 'EN_ATTENTE',
                'badge-danger': rdv.statut === 'ANNULE'
              }">
          {{ rdv.statut }}
        </span>
          <button class="btn-annuler" (click)="deleteRdv(rdv.id)">Supprimer rdv</button>
        </div>

      </div>
    </div>
  </section>


</div>

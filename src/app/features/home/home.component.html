<div class="home-container">

  <!-- NAVBAR -->
  <nav class="navbar">
    <div class="logo">
      <span>ü©∫ ClinikTime</span>
    </div>

    <div class="nav-links">
      <a routerLink="/profile" class="nav-link">Mon Profil</a>

      <a
        *ngIf="(authService.currentUser$ | async)?.role === 'Medecin'"
        routerLink="/medecin"
        class="nav-link">
        Espace M√©decin
      </a>

      <button (click)="logout()" class="btn-logout">
        D√©connexion
      </button>
    </div>
  </nav>

  <!-- HERO / SEARCH -->
  <section class="hero-section">
    <div class="hero-content">
      <h1>Prenez soin de votre sant√©</h1>
      <p>Trouvez un rendez-vous rapide avec un praticien qualifi√©.</p>

      <form
        [formGroup]="searchForm"
        (ngSubmit)="onSearch($event)"
        class="search-bar">

        <div class="input-group">
          <i>üîç</i>
          <input
            type="text"
            formControlName="term"
            placeholder="Sp√©cialit√© (ex: Dentiste)">
        </div>

        <div class="divider"></div>

        <button type="submit">Rechercher</button>
      </form>
    </div>
  </section>

  <!-- üîé RESULTATS -->
  <section class="info-section" *ngIf="searched">

    <h2>R√©sultats de recherche</h2>

    <p *ngIf="loading">üîÑ Recherche en cours...</p>

    <p *ngIf="!loading && medecins.length === 0">
      Aucun m√©decin trouv√© pour cette sp√©cialit√©.
    </p>

    <div class="cards-grid" *ngIf="!loading && medecins.length > 0">
      <div class="card" *ngFor="let m of medecins">

        <div class="card-header">
          <div class="avatar-circle">
            {{ getInitial(m.prenom) }}
          </div>

          <div>
            <h3>Dr {{ m.prenom }} {{ m.nom }}</h3>
            <span>üìû {{ m.telephone }}</span>
          </div>
        </div>

        <div class="card-body">
          <button
            class="btn-outline"
            (click)="openRdvPanel(m)">
            Prendre rendez-vous
          </button>
        </div>

      </div>
    </div>

  </section>

  <!-- ü©∫ PANEL PRISE DE RENDEZ-VOUS -->
  <div class="rdv-overlay" *ngIf="showRdvPanel" (click)="closeRdvPanel()">
    <div class="rdv-panel" (click)="$event.stopPropagation()">

      <div class="rdv-header">
        <div>
          <h2>Prendre rendez-vous</h2>
          <p class="rdv-subtitle" *ngIf="selectedMedecin">
            Avec <strong>Dr {{ selectedMedecin.prenom }} {{ selectedMedecin.nom }}</strong>
          </p>
        </div>

        <button class="rdv-close" type="button" (click)="closeRdvPanel()">‚úï</button>
      </div>

      <div class="rdv-form">

        <!-- Fiche patient -->
        <div class="rdv-field">
          <label>Fiche patient</label>
          <select [(ngModel)]="selectedFichePatientId">
            <option [ngValue]="null">-- choisir --</option>
            <option *ngFor="let f of fichesPatients" [ngValue]="f.id ?? null">
              {{ f.prenom }} {{ f.nom }} ({{ f.lienParente }})
            </option>
          </select>
          <p class="rdv-hint" *ngIf="fichesPatients.length === 0">
            Vous n'avez pas encore de fiche patient. Cr√©ez-en une dans votre profil.
          </p>
        </div>

        <!-- Date -->
        <div class="rdv-field">
          <label>Date</label>
          <input
            type="date"
            [(ngModel)]="selectedDate"
            (change)="loadCreneaux()" />
        </div>

        <!-- Motif -->
        <div class="rdv-field">
          <label>Motif (optionnel)</label>
          <input
            type="text"
            [(ngModel)]="motif"
            placeholder="Ex: contr√¥le, douleur, consultation..." />
        </div>

        <!-- Cr√©neaux -->
        <div class="rdv-field">
          <div class="rdv-creneaux-head">
            <label>Cr√©neaux disponibles</label>
            <button
              type="button"
              class="btn-outline rdv-refresh"
              (click)="loadCreneaux()"
              [disabled]="!selectedDate || !selectedMedecin">
              Rafra√Æchir
            </button>
          </div>

          <p *ngIf="loadingCreneaux">üîÑ Chargement des cr√©neaux...</p>

          <p *ngIf="!loadingCreneaux && selectedDate && creneauxLibres.length === 0">
            Aucun cr√©neau disponible pour cette date.
          </p>

          <!-- ‚úÖ AFFICHAGE CORRECT DES CRENEAUX -->
          <div class="creneaux-grid" *ngIf="!loadingCreneaux && creneauxLibres.length > 0">
            <button
              type="button"
              class="creneau"
              *ngFor="let c of creneauxLibres"
              [class.selected]="c === selectedCreneau"
              (click)="selectCreneau(c)">
              {{ c.debut | date:'HH:mm' }} ‚Äì {{ c.fin | date:'HH:mm' }}
            </button>
          </div>
        </div>

        <!-- Actions -->
        <div class="rdv-actions">
          <button type="button" class="btn-cancel" (click)="closeRdvPanel()">
            Annuler
          </button>

          <button
            type="button"
            class="btn-primary"
            (click)="confirmerRdv()"
            [disabled]="!selectedFichePatientId || !selectedCreneau || !selectedMedecin">
            Confirmer le rendez-vous
          </button>
        </div>

      </div>
    </div>
  </div>

  <!-- üïí DERNIERS RDV -->
  <section class="info-section" *ngIf="!searched">
    <h2>Vos derniers rendez-vous</h2>

    <div class="cards-grid">
      <div class="card" *ngFor="let rdv of lastAppointments">

        <div class="card-header">
          <div class="avatar-circle">
            {{ getInitial(rdv.doctor) }}
          </div>

          <div>
            <h3>{{ rdv.doctor }}</h3>
            <span>{{ rdv.specialty }}</span>
          </div>
        </div>

        <div class="card-body">
          <p>üìÖ {{ rdv.date }} √† {{ rdv.time }}</p>
          <button class="btn-outline">Reprendre RDV</button>
        </div>

      </div>

      <div class="card promo-card">
        <h3>Besoin d'un check-up ?</h3>
        <p>D√©couvrez nos m√©decins g√©n√©ralistes disponibles aujourd'hui.</p>
        <button class="btn-link">Voir les disponibilit√©s</button>
      </div>
    </div>
  </section>

</div>
